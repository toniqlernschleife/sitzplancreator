<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sitzplan Creator Pro - Final Version</title>
    <style>
        :root {
            --color-background-warm: #fdf6e3;
            --color-text: #333;
            --color-control-bg: #fff;
            --color-border: #ccc;
            --color-desk: #f3e5ab;
            --color-desk-border: #d2b48c;
            --color-seat: #fff8dc;
            --color-blackboard: #4a5d43;
            --color-btn-primary: #709a80;
            --color-btn-secondary: #8da399;
            --color-btn-danger: #e74c3c;
            --color-blocked: #ffcccc;
            --color-first-row: #b8860b;
            --color-locked: #555;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--color-background-warm); color: var(--color-text); margin: 0; padding: 10px; }
        .main-layout { display: flex; gap: 20px; max-width: 100vw; }
        .sp-sidebar { flex: 0 0 320px; background: var(--color-control-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--color-border); max-height: 95vh; overflow-y: auto; }
        .sp-main { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .top-bar { background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--color-border); display: flex; justify-content: flex-end; align-items: center; gap: 10px; flex-wrap: wrap; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.85rem; }
        textarea, input, select { width: 100%; padding: 6px; margin-top: 3px; border-radius: 4px; border: 1px solid var(--color-border); box-sizing: border-box; font-size: 0.85rem; }
        .dynamic-group { border-left: 3px solid var(--color-btn-danger); padding-left: 8px; margin-top: 8px; position: relative; background: #fff5f5; padding: 5px; }
        .sp-btn { padding: 8px 15px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-add { background: #eee; color: #333; font-size: 0.75rem; margin-top: 5px; }
        .btn-primary { background: var(--color-btn-primary); }
        .btn-secondary { background: var(--color-btn-secondary); }
        .btn-danger { background: var(--color-btn-danger); }

        .sp-view { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; display: inline-block; min-width: 100%; box-sizing: border-box; overflow-x: auto; position: relative;}
        .sp-grid { display: flex; justify-content: center; align-items: flex-end; gap: 30px; margin-bottom: 20px; }
        .sp-col { display: flex; flex-direction: column-reverse; gap: 15px; min-width: 140px; padding: 10px; border: 1px dashed #eee; }
        .sp-blackboard { width: 60%; margin: 20px auto 0; background: var(--color-blackboard); color: white; text-align: center; padding: 10px; border: 4px solid #5c4033; font-weight: bold; border-radius: 4px; position: relative;}
        
        /* Warteliste f√ºr Sch√ºler ohne Platz */
        #waiting-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 10px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffeeba; display: none;}
        .waiting-student { padding: 5px 10px; background: var(--color-btn-secondary); color: white; border-radius: 3px; cursor: grab; font-weight: bold; font-size: 0.8rem;}

        .desk { background: var(--color-desk); border: 2px solid var(--color-desk-border); border-radius: 6px; padding: 8px; display: flex; justify-content: space-around; position: relative; cursor: grab; min-width: 120px; }
        .desk.vertical { flex-direction: column; width: 60px; height: 100px; align-self: center; min-width: 60px; }
        .desk.is-dragging { opacity: 0.3; }
        .sp-col .desk:first-child { border: 3px solid var(--color-first-row); }
        .sp-col .desk:first-child::after { content: "VORNE"; position: absolute; bottom: -18px; font-size: 8px; color: var(--color-first-row); font-weight: bold; left: 50%; transform: translateX(-50%); }

        .seat { width: 50px; height: 35px; background: var(--color-seat); border: 1px solid var(--color-desk-border); border-radius: 3px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; cursor: pointer; user-select: none; }
        .seat.locked { background: var(--color-locked); color: white; }
        .seat.blocked { background: var(--color-blocked); color: #c00; }
        .seat.drag-over { border: 2px dashed #000; background: #e9ecef; }

        .desk-tools { position: absolute; top: -10px; right: -5px; display: flex; gap: 2px; z-index: 10; }
        .mini-btn { width: 16px; height: 16px; font-size: 9px; border-radius: 50%; border: none; cursor: pointer; color: white; background: #bbb; }
        .mini-btn.rotate { background: #5bc0de; }
        .mini-btn.del { background: var(--color-btn-danger); }

        @media print { .sp-sidebar, .top-bar, .desk-tools, #waiting-list { display: none !important; } body { padding: 0; background: white; } .sp-view { border: none; width: 100%; } }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="sp-sidebar">
        <h3 style="margin-top:0">Einstellungen</h3>
        <label>Format w√§hlen</label>
        <select id="select-format" onchange="SP.initLayout()">
            <option value="3-5">3 Bankreihen √° 5 Tische</option>
            <option value="4-4">4 Bankreihen √° 4 Tische</option>
            <option value="5-3">5 Bankreihen √° 3 Tische</option>
        </select>
        <label>Sch√ºlerliste</label>
        <textarea id="inp-students" rows="6" placeholder="Anna, Ben, Clara..."></textarea>
        <label>üëì Erste Reihe Sitzer</label>
        <input type="text" id="inp-front" placeholder="Moritz, Sara">
        <label>üõë Alleine-Sitzer</label>
        <input type="text" id="inp-solo" placeholder="Max">
        <label>‚ù§Ô∏è Wunschnachbarn (Paare)</label>
        <div id="container-wishes"></div>
        <button class="sp-btn btn-add" onclick="SP.addWishInput()">+ Wunsch hinzuf√ºgen</button>
        <label>‚ùå Nicht nebeneinander (Kategorien)</label>
        <div id="container-no-groups"></div>
        <button class="sp-btn btn-add" onclick="SP.addConflictGroup()">+ Gruppe hinzuf√ºgen</button>
    </div>

    <div class="sp-main">
        <div class="top-bar">
            <button class="sp-btn btn-primary" onclick="SP.roll()">üé≤ Sitzplan w√ºrfeln</button>
            <button class="sp-btn btn-secondary" onclick="SP.addDeskToFirstCol()">‚ûï Tisch dazu</button>
            <button class="sp-btn btn-secondary" onclick="SP.addColumnWithDesks()">‚ûï Reihe dazu</button>
            <button class="sp-btn" style="background:#888" onclick="SP.clearNamesOnly()">üóëÔ∏è Namen leeren</button>
            <button class="sp-btn btn-danger" onclick="SP.initLayout()">üßπ Reset Layout</button>
            <button class="sp-btn" style="background:#4682b4" onclick="window.print()">üñ®Ô∏è Drucken</button>
        </div>

        <div class="sp-view">
            <div class="sp-grid" id="sp-grid"></div>
            <div id="waiting-list"></div>
            <div class="sp-blackboard">TAFEL</div>
        </div>
    </div>
</div>

<script>
const SP = (function() {
    let deskIdCounter = 0;
    let draggedItem = null;
    let draggedDesk = null;
    let draggedWaitingStudent = null;

    function init() { initLayout(); addWishInput(); addConflictGroup(); }

    function initLayout() {
        const [cols, rows] = document.getElementById('select-format').value.split('-').map(Number);
        const grid = document.getElementById('sp-grid');
        grid.innerHTML = '';
        for(let c=1; c<=cols; c++) {
            const col = document.createElement('div');
            col.className = 'sp-col'; col.id = `col-${c}`;
            bindColEvents(col);
            for(let r=0; r<rows; r++) col.appendChild(createDesk());
            grid.appendChild(col);
        }
    }

    function addColumnWithDesks() {
        const grid = document.getElementById('sp-grid');
        const rows = document.getElementById('select-format').value.split('-')[1];
        const col = document.createElement('div');
        col.className = 'sp-col'; col.id = `col-${grid.children.length + 1}`;
        bindColEvents(col);
        for(let r=0; r<rows; r++) col.appendChild(createDesk());
        grid.appendChild(col);
    }

    function addDeskToFirstCol() { const firstCol = document.querySelector('.sp-col'); if(firstCol) firstCol.appendChild(createDesk()); }

    function createDesk() {
        const div = document.createElement('div');
        div.className = 'desk'; div.id = `desk-${deskIdCounter++}`; div.draggable = true;
        div.innerHTML = `<div class="desk-tools"><button class="mini-btn rotate" onclick="SP.rotate(this)">‚Ü∫</button><button class="mini-btn del" onclick="this.closest('.desk').remove()">‚úï</button></div>
                         <div class="seat s1" draggable="true" onclick="SP.toggleLock(this)">?</div>
                         <div class="seat s2" draggable="true" onclick="SP.toggleLock(this)">?</div>`;
        bindDeskEvents(div);
        div.querySelectorAll('.seat').forEach(bindSeatEvents);
        return div;
    }

    function bindColEvents(col) {
        col.ondragover = e => { e.preventDefault(); if (draggedDesk) { const after = getDragAfterElement(col, e.clientY); if (after == null) col.appendChild(draggedDesk); else col.insertBefore(draggedDesk, after); } };
    }

    function getDragAfterElement(container, y) {
        const draggables = [...container.querySelectorAll('.desk:not(.is-dragging)')];
        return draggables.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function bindDeskEvents(desk) {
        desk.addEventListener('dragstart', (e) => { if(e.target.classList.contains('seat')) return; draggedDesk = desk; setTimeout(() => desk.classList.add('is-dragging'), 0); });
        desk.addEventListener('dragend', () => { desk.classList.remove('is-dragging'); draggedDesk = null; });
    }

    function bindSeatEvents(seat) {
        seat.addEventListener('dragstart', (e) => {
            if(seat.textContent === '?' || seat.textContent === 'X' || (seat.textContent === 'üîí' && !draggedWaitingStudent)) { e.preventDefault(); return; }
            draggedItem = seat; e.stopPropagation(); setTimeout(() => seat.classList.add('is-dragging'), 0);
        });
        seat.addEventListener('dragend', () => { seat.classList.remove('is-dragging'); draggedItem = null; seat.classList.remove('drag-over');});
        seat.ondragover = e => { e.preventDefault(); seat.classList.add('drag-over'); };
        seat.ondragleave = () => seat.classList.remove('drag-over');
        seat.ondrop = e => {
            e.preventDefault();
            seat.classList.remove('drag-over');
            // Drop von Warteliste
            if(draggedWaitingStudent) {
                seat.textContent = draggedWaitingStudent.textContent;
                seat.classList.remove('locked', 'blocked');
                draggedWaitingStudent.remove();
                if(document.getElementById('waiting-list').children.length === 0) document.getElementById('waiting-list').style.display = 'none';
                draggedWaitingStudent = null;
                return;
            }
            // Drop von anderem Sitz
            if(draggedItem && draggedItem !== seat) {
                const t1 = seat.textContent, c1 = seat.className;
                seat.textContent = draggedItem.textContent; seat.className = draggedItem.className;
                draggedItem.textContent = t1; draggedItem.className = c1;
            }
        };
    }

    function rotate(btn) { btn.closest('.desk').classList.toggle('vertical'); }
    function toggleLock(el) { if(el.textContent !== '?' && el.textContent !== 'üîí') return; el.classList.toggle('locked'); el.textContent = el.classList.contains('locked') ? 'üîí' : '?'; }
    function addWishInput() {
        const container = document.getElementById('container-wishes');
        const div = document.createElement('div'); div.className = 'dynamic-row'; div.style.display = 'flex'; div.style.gap = '2px'; div.style.marginTop = '2px';
        div.innerHTML = `<input type="text" placeholder="A"> <input type="text" placeholder="B"> <button class="mini-btn del" onclick="this.parentElement.remove()">‚úï</button>`;
        container.appendChild(div);
    }
    function addConflictGroup() {
        const container = document.getElementById('container-no-groups');
        const div = document.createElement('div'); div.className = 'dynamic-group';
        div.innerHTML = `<textarea rows="2" placeholder="Namen untereinander..."></textarea><button class="mini-btn del" style="position:absolute; right:2px; top:2px;" onclick="this.parentElement.remove()">‚úï</button>`;
        container.appendChild(div);
    }
    function clearNamesOnly() { document.querySelectorAll('.seat').forEach(s => { if(!s.classList.contains('locked')) { s.textContent = '?'; s.classList.remove('blocked'); } }); document.getElementById('waiting-list').innerHTML = ''; document.getElementById('waiting-list').style.display = 'none';}

    function roll() {
        clearNamesOnly();
        const students = getList('inp-students');
        const frontSus = getList('inp-front');
        const soloSus = getList('inp-solo');
        const wishes = Array.from(document.querySelectorAll('#container-wishes .dynamic-row')).map(row => [row.querySelectorAll('input')[0].value.trim(), row.querySelectorAll('input')[1].value.trim()].filter(n => n)).filter(p => p.length === 2);
        const conflictGroups = Array.from(document.querySelectorAll('#container-no-groups textarea')).map(tx => tx.value.split('\n').map(s => s.trim()).filter(s => s)).filter(g => g.length > 1);

        if(students.length === 0) return alert("Bitte Sch√ºlerliste ausf√ºllen!");

        let desks = Array.from(document.querySelectorAll('.desk')).map(d => ({
            el: d, s1: d.querySelector('.s1'), s2: d.querySelector('.s2'),
            isFront: d === d.parentElement.firstElementChild,
            content: [d.querySelector('.s1').classList.contains('locked') ? "LOCKED" : null, d.querySelector('.s2').classList.contains('locked') ? "LOCKED" : null]
        }));

        let unassigned = shuffle([...students]);

        // 1. Alleinesitzer auf PL√ÑTZE NEBEN GESPERRTEN (LOCKED) setzen (Platz sparen)
        soloSus.forEach(name => {
            if(!unassigned.includes(name)) return;
            let d = desks.find(d => (d.content[0] === "LOCKED" && d.content[1] === null) || (d.content[1] === "LOCKED" && d.content[0] === null));
            if(d) {
                let idx = d.content.indexOf(null);
                d.content[idx] = name;
                unassigned = unassigned.filter(n => n !== name);
            }
        });

        // 2. Wunschnachbarn (Doppeltisch)
        wishes.forEach(pair => {
            let d = desks.find(d => d.content[0] === null && d.content[1] === null);
            if(d) { d.content = [pair[0], pair[1]]; unassigned = unassigned.filter(n => !pair.includes(n)); }
        });

        // 3. Restliche Alleinesitzer (besetzen eigenen Doppeltisch)
        soloSus.forEach(name => {
            if(!unassigned.includes(name)) return;
            let d = desks.find(d => d.content[0] === null && d.content[1] === null);
            if(d) { d.content = [name, "BLOCKED"]; unassigned = unassigned.filter(n => n !== name); }
        });

        // 4. Restliche Sch√ºler
        unassigned.forEach(name => {
            let d = shuffle(desks).find(d => d.content.includes(null));
            if(d) d.content[d.content.indexOf(null)] = name;
        });

        // 5. Konflikt-Pr√ºfung
        let attempts = 0, conflictFound = true;
        while(conflictFound && attempts < 100) {
            conflictFound = false;
            for (let group of conflictGroups) {
                for (let d of desks) {
                    let inGroupAtDesk = d.content.filter(n => group.includes(n));
                    if (inGroupAtDesk.length > 1) {
                        conflictFound = true;
                        let studentToMove = inGroupAtDesk[0];
                        let idxInDesk = d.content.indexOf(studentToMove);
                        let swapDesk = shuffle(desks).find(sd => sd !== d && !sd.content.includes("LOCKED") && !sd.content.includes("BLOCKED") && sd.content[0] && !group.some(gn => sd.content.includes(gn)));
                        if (swapDesk) { let temp = d.content[idxInDesk]; d.content[idxInDesk] = swapDesk.content[0]; swapDesk.content[0] = temp; }
                    }
                }
            }
            attempts++;
        }

        // 6. Erste-Reihe Tausch
        frontSus.forEach(name => {
            let curD = desks.find(d => d.content.includes(name));
            if(curD && !curD.isFront) {
                let frontD = desks.find(d => d.isFront && !frontSus.some(fn => d.content.includes(fn)));
                if(frontD) { let temp = [...curD.content]; curD.content = [...frontD.content]; curD.content = [...frontD.content]; frontD.content = temp; }
            }
        });

        // Finales Rendering & Abgleich
        let sittingNames = [];
        desks.forEach(d => {
            renderSeat(d.s1, d.content[0]); renderSeat(d.s2, d.content[1]);
            d.content.forEach(val => { if(val && val !== "LOCKED" && val !== "BLOCKED") sittingNames.push(val); });
        });

        // √úbriggebliebene Sch√ºler anzeigen
        let leftOver = students.filter(n => !sittingNames.includes(n));
        const waitListEl = document.getElementById('waiting-list');
        waitListEl.innerHTML = '';
        if(leftOver.length > 0) {
            waitListEl.style.display = 'flex';
            waitListEl.innerHTML = `<div style="width:100%; font-size:0.8rem; color:#856404; margin-bottom:5px;">‚ö†Ô∏è Kein Platz f√ºr: (Zieh sie auf gesperrte üîí Pl√§tze)</div>`;
            leftOver.forEach(name => {
                const div = document.createElement('div'); div.className = 'waiting-student'; div.textContent = name; div.draggable = true;
                div.addEventListener('dragstart', () => { draggedWaitingStudent = div; });
                waitListEl.appendChild(div);
            });
        } else {
            waitListEl.style.display = 'none';
        }
    }

    function renderSeat(el, val) {
        if(val === "LOCKED") return; el.classList.remove('blocked');
        if(val === "BLOCKED") { el.textContent = "X"; el.classList.add('blocked'); }
        else if(val) { el.textContent = val; el.classList.remove('locked'); }
        else el.textContent = "?";
    }

    function getList(id) { return document.getElementById(id).value.split(/[,\n]+/).map(s => s.trim()).filter(s => s); }
    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

    window.onload = init;
    return { initLayout, roll, addWishInput, addConflictGroup, toggleLock, clearNamesOnly, rotate, addDeskToFirstCol, addColumnWithDesks };
})();
</script>
</body>
</html>
